---
title: "Data wragling"
author: "Elvin Mammadov"
date: "2025-04-20"
output: html_document
---

## Preparation: data + packages

```{r loading packages, include=FALSE}
#install.packages("summarytools")
#install.packages("devtools")

library(haven)
library(here)
library(stargazer)
library(summarytools)
library(readxl)
library(dplyr)
library(lubridate)
library(ggplot2)

#Vdem data 
#devtools::install_github("vdeminstitute/vdemdata")
library(vdemdata)
vdem <- vdemdata::vdem

#opening datasets (individual survey)
unzip("Data/GPS_Dataset.zip")
unzip("GPS_dataset_individual_level.zip")
GPS_indiv <- read_dta(here("individual_new.dta"))

#opening datasets (country survey)
unzip(here("GPS_dataset_country_level.zip"))
GPS_country <- read_dta(here("Data", "country.dta"))

#openning data polity
p5 <- read_excel(here("Data", "p5v2018.xls"))

#converting the column encodings to UTF-8
names(GPS_indiv)
GPS_indiv <- GPS_indiv %>%
  mutate(across(where(is.character), ~ iconv(., from = "", to = "UTF-8")))

view(dfSummary(GPS_country))
view(dfSummary(GPS_indiv))
view(dfSummary(p5))
#view(dfSummary(vdem))  #Takes very long to compute

```

## Data wrangling

Questions for meeting on 29.04. :

-   **How to decide on a threshold of assigning *generate_regime_change*?** So far, we have been working with liberal democracy index from V-Dem, but there are more options -\> should we aggregate them into one?

-   **New variable capturing the "formative years" -\> 18 years of age? Or younger? -\> Only assign treatment if regime changed in this time?**

-   Controls

    Adding another variable capturing the **exposure** to different political regime over a very **long time horizon** -\> might influence the resident's economic preferences. Similar approach in paper @friehe_time_2020

    Adding interaction term $TimeToTreatment_{c,t,k}$ as an indicator for being $k$ **periods away from the treatment** (regime change) in country $c$ at time $t$?

-   **Method**: **staggered/stacked DiD** (to account for time-varying treatment assignment)

$$Y_{ict} = \beta_0 + \sum_{k} \beta_{1k}(RegimeChange_{c,t-k}) + \beta_2 X\_{ict} + \gamma_c + \delta_t + \theta_a + \varepsilon_{ict}$$ where:

$Y_{ict}$ represents the economic preference outcome (trust, risk-taking, patience, etc.) for individual $i$ in country $c$ at time $t$ -\> **Separate model for each preference / try to combine them?**

$RegimeChange_{c,t-k}$ is a dummy variable indicating whether a country $c$ experienced a regime change $k$ periods before time $t$

$X_{ict}$ is a vector of individual-level control variables (gender, math skills)

$\gamma_c$ represents country fixed effects

$\delta_t$ represents time/year fixed effects

$\theta_a$ represents **age group/cohort** fixed effects

$\varepsilon_{ict}$ is the error term

## Comparison DiD methods

| Callaway Sant' Anna (2021) | Chaisemartin and D'Haultfoeuille (2020) |
|------------------------------------|------------------------------------|
| R package "did" | R package DIDmultiplegt |
| Designed for treatment with absorbing state (once country adopts democracy, it stays democratic) -\> regime changes (democratization) tends to be more persistent? | handles treatment reversibility |
|  |  |

```{r}

#selecting necessary columns
vdem_sub <- vdem %>%
  select(country_name, year, v2x_libdem)

#calculating birt_years and selecting necessary columns
gps_sub <- GPS_indiv %>%
  mutate(birth_year = year(date) - age) %>%
  select(country, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender, birth_year)


#creating regime change function
generate_regime_change <- function(data, threshold = 0.03) {
  data %>%
    arrange(country_name, year) %>%
    group_by(country_name) %>%
    mutate(
      libdem_diff = v2x_libdem - lag(v2x_libdem),
      regime_change = ifelse(libdem_diff > threshold, 1, 0)
    ) %>%
    ungroup()
}

#then applying this function to our data , *threshold* is example, this number can be different.

vdem_with_regimes <- generate_regime_change(vdem_sub, threshold = 0.03)

head(vdem_with_regimes)


#Imagine the person faced with democracy at 18
gps_sub <- gps_sub %>%
  mutate(year_at_18 = birth_year + 18)

#merging data
merged_data <- gps_sub %>%
  left_join(vdem_with_regimes, 
            by = c("country" = "country_name", "year_at_18" = "year"))
```

### EDA

```{r}
view(dfSummary(merged_data))
# Taking a look at number of untreated/treated observations
table(merged_data$regime_change)


```

### Identifying assumptions

#### Staggered treatment adoption

Once units receive treatment, they remain treated throughout the observation period

#### Parallel Trends assumption with never-treated units

-   Sufficiently large group of units, that have never received treatment

-   Never-treated units must be similar enough to the units that eventually receive treatment so that we can validly compare their outcomes

```{r}
#package for staggered DiD
#install.packages("did")
library(did)

#devtools::install_github("jonathandroth/pretrends")
library(pretrends)
```
