---
title: "Data wragling"
date: "2025-04-20"
output: html_document
---

# Loading

```{r loading packages, include=FALSE}
#install.packages("pacman")
library(pacman)
p_load(haven,
       here,
       stargazer,
       summarytools,
       readxl,
       dplyr,
       lubridate,
       ggplot2,
       vdemdata,
       summarytools,
       devtools,
       zoo,
       tidyverse)

#install.packages("summarytools")
#install.packages("devtools")
#devtools::install_github("vdeminstitute/vdemdata")


#Vdem data 
vdem <- vdemdata::vdem

#opening datasets (individual survey)
#unzip(here("Input","GPS_Dataset.zip"))
#unzip(here("Input", "GPS_dataset_individual_level.zip"))
GPS_indiv <- read_dta(here("Input","individual_v11_new.dta"))

#openning data polity
p5 <- read_excel(here("Input", "p5v2018.xls"))

#converting the column encodings to UTF-8
names(GPS_indiv)
GPS_indiv <- GPS_indiv %>%
  mutate(across(where(is.character), ~ iconv(., from = "", to = "UTF-8")))

view(dfSummary(GPS_indiv))
view(dfSummary(p5))
#view(dfSummary(vdem))  #Takes very long to compute

```

# Data wrangling

Questions for meeting on 29.04. :

-   **How to decide on a threshold of assigning *generate_regime_change*?** So far, we have been working with liberal democracy index from V-Dem, but there are more options -\> should we aggregate them into one?

    *answer whether its a sudden change or linear -\> which are better suited?*

*Restrict just to one schock: autoritative -\> democratic*

-   **Separate model for each preference / try to combine them?** *check for literature- maybe choose 2 based on this, if we use all of them, Lessmann will ask about multiple hypotheses testing :)*

*time, age, cohort fixed effects*

*age/cohort effects could be problematic*

*net out age effect from economic preferences -\>whats the effect of risk aversion? (next step)*

*if not DiD: mean comparisons -\> give up on causal effects -\> more about living under regime than regime changes -\>already dome evidence on this*

```{r}
#selecting necessary columns
vdem_sub <- vdem %>%
  select(country_name,country_text_id, year, v2x_libdem)

#calculating birth_years and selecting necessary columns
gps_sub <- GPS_indiv %>%
  mutate(birth_year = year(date) - age ) %>% mutate(year_3= birth_year + 3) %>% 
  select(id_gallup, age , date, country,isocode, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender, birth_year, year_3)

gps_sub <- gps_sub %>%
  mutate(year = year(date)) %>% select(!date)

#Imagine the person faced with democracy at 18
gps_sub <- gps_sub %>%
  mutate(year_adult = birth_year + 18) 

gps_sub <- gps_sub %>%
  rename(interview_year = year)

#Keeping just complete cases and saving the observations containing NA's as a separate dataframe
gps_NA <- gps_sub %>%
  filter(!complete.cases(.))

gps_sub <- gps_sub %>%
  drop_na()

```

## Treatment

### First step: regime changes on country level

```{r regime changes periods on country level}
# Function to create country-level regime change data
create_country_regime_data <- function(democracy_data, threshold = 0.05, country_filter = NULL) {
  
  # Filter for specific countries if provided
  if (!is.null(country_filter)) {
    democracy_data <- democracy_data %>%
      filter(country_text_id %in% country_filter)
  }
  
  # First, identify regime changes at country level
  country_regime_changes <- democracy_data %>%
    group_by(country_text_id) %>%
    arrange(year) %>%
    mutate(
      # Calculate rolling standard errors for confidence intervals
      v2x_libdem_rolling_sd = rollapply(v2x_libdem, width = 5,
                                       FUN = function(x) sd(x, na.rm = TRUE),
                                       fill = NA, align = "center"),
      v2x_libdem_rolling_n = rollapply(v2x_libdem, width = 5,
                                      FUN = function(x) sum(!is.na(x)),
                                      fill = NA, align = "center"),
      
      # Calculating confidence intervals
      country_sd = sd(v2x_libdem, na.rm = TRUE),
      country_n = n(),
      
      v2x_libdem_se = case_when(
        !is.na(v2x_libdem_rolling_sd) & v2x_libdem_rolling_n > 1 ~
          v2x_libdem_rolling_sd / sqrt(v2x_libdem_rolling_n),
        TRUE ~ country_sd / sqrt(country_n)
      ),
      
      df = case_when(
        !is.na(v2x_libdem_rolling_n) & v2x_libdem_rolling_n > 1 ~
          v2x_libdem_rolling_n - 1,
        TRUE ~ country_n - 1
      ),
      
      t_stat = qt(0.975, df = df),
      ci_lower = v2x_libdem - t_stat * v2x_libdem_se,
      ci_upper = v2x_libdem + t_stat * v2x_libdem_se,
      
      # Look at 10-year changes
      libdem_diff = v2x_libdem - lag(v2x_libdem, 10),
      ci_lower_lag10 = lag(ci_lower, 10),
      ci_upper_lag10 = lag(ci_upper, 10),
      
      # Check for non-overlapping confidence intervals
      ci_non_overlapping = case_when(
        is.na(ci_lower) | is.na(ci_upper_lag10) ~ 0,
        ci_lower > ci_upper_lag10 | ci_upper < ci_lower_lag10 ~ 1,
        TRUE ~ 0
      ),
      
      # Identify regime changes
      regime_change = ifelse(ci_non_overlapping == 1 & 
                            !is.na(libdem_diff) & 
                            abs(libdem_diff) > threshold, 1, 0),
      
      # Create treatment variable with 3 categories
      treatment = case_when(
        regime_change == 1 & libdem_diff > 0 ~ 2,  # Democratization
        regime_change == 1 & libdem_diff < 0 ~ 1,  # Autocratization
        TRUE ~ 0  # No regime change
      ),
      
      # Create factor with labels
      treatment_factor = factor(treatment,
                               levels = c(0, 1, 2),
                               labels = c("No change", "Autocratization", "Democratization"))
    ) %>%
    select(country_text_id, country_name, year, v2x_libdem, treatment, treatment_factor)
  
  return(country_regime_changes)
}

# Get unique countries from gps_sub
countries_to_analyze <- unique(gps_sub$isocode)

# Create the country-level data for selected countries only
country_data <- create_country_regime_data(vdem_sub, 
                                         threshold = 0.2,
                                         country_filter = countries_to_analyze)

# Filter for periods after 1920
country_data <- country_data %>%
  filter(year > 1910)

# For multiple treatment categories, we need to create separate binary indicators
# Creating binary indicators for each treatment type
country_data_binary <- country_data %>%
  mutate(
    autocratization = ifelse(treatment == 1, 1, 0),
    democratization = ifelse(treatment == 2, 1, 0),
    any_change = ifelse(treatment != 0, 1, 0)
  )
```

### Second step: connecting with GPS data

```{r}
# Function to merge country-level regime change data with individual GPS data
merge_regime_changes_with_individuals <- function(gps_data, country_data_binary) {
  
  # First, reshaping country data to have one row per regime change
  # Extract all regime changes (where treatment != 0)
  regime_changes_long <- country_data_binary %>%
    filter(treatment != 0) %>%
    select(country_text_id, year, treatment, autocratization, democratization) %>%
    rename(regime_change_year = year)
  
  # Join with GPS data
  # Each individual gets matched with all regime changes in their country
  merged_data <- gps_data %>%
    left_join(regime_changes_long,
              by = c("isocode" = "country_text_id"),
              relationship = "many-to-many") %>%
    mutate(
      # Calculate age at regime change
      age_at_regime_change = regime_change_year - birth_year,
      
      # Check if regime change occurred during formative years (ages 3-18)
      experienced_formative_change = case_when(
        is.na(regime_change_year) ~ 0,
        age_at_regime_change >= 3 & age_at_regime_change <= 18 ~ 1,
        TRUE ~ 0
      ),
      
      # Type of change experienced during formative years
      formative_autocratization = experienced_formative_change * autocratization,
      formative_democratization = experienced_formative_change * democratization
    )
  
  # Aggregate to individual level - one row per person
  individual_summary <- merged_data %>%
    group_by(id_gallup) %>%
    summarize(
      # Keep all original individual variables (take first value)
      across(c(age, country, isocode, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender,  birth_year, year_3, year_adult), 
             ~first(.)),
      
      # Treatment indicators - handle cases with no regime changes
      formative_regime_change = if(all(is.na(experienced_formative_change))) 0 else max(experienced_formative_change, na.rm = TRUE),
      formative_autocratization = if(all(is.na(formative_autocratization))) 0 else max(formative_autocratization, na.rm = TRUE),
      formative_democratization = if(all(is.na(formative_democratization))) 0 else max(formative_democratization, na.rm = TRUE),
      
      # Count of regime changes
      n_formative_changes = sum(experienced_formative_change, na.rm = TRUE),
      n_formative_autocratizations = sum(formative_autocratization, na.rm = TRUE),
      n_formative_democratizations = sum(formative_democratization, na.rm = TRUE),
      
      # Details of first formative regime change
      first_formative_year = ifelse(
        any(experienced_formative_change == 1, na.rm = TRUE),
        min(regime_change_year[experienced_formative_change == 1], na.rm = TRUE),
        NA_real_
      ),
      first_formative_age = ifelse(
        any(experienced_formative_change == 1, na.rm = TRUE),
        min(age_at_regime_change[experienced_formative_change == 1], na.rm = TRUE),
        NA_real_
      ),
      first_formative_type = case_when(
        any(experienced_formative_change == 1, na.rm = TRUE) ~ 
          first(treatment[experienced_formative_change == 1]),
        TRUE ~ 0
      ),
      
      # List of all formative regime change years (if needed)
      all_formative_years = list(regime_change_year[experienced_formative_change == 1]),
      all_formative_ages = list(age_at_regime_change[experienced_formative_change == 1]),
      
      .groups = "drop"
    )
  
  # Print summary statistics
  cat("\n=== Summary Statistics ===\n")
  cat("Total individuals:", nrow(individual_summary), "\n")
  cat("Individuals with formative regime changes:", 
      sum(individual_summary$formative_regime_change), "\n")
  cat("- Experienced autocratization:", 
      sum(individual_summary$formative_autocratization), "\n")
  cat("- Experienced democratization:", 
      sum(individual_summary$formative_democratization), "\n")
  cat("Average age at first formative change:", 
      round(mean(individual_summary$first_formative_age, na.rm = TRUE), 2), "\n")
  
  # Create frequency table
  cat("\nFormative regime change distribution:\n")
  print(table(individual_summary$formative_regime_change))
  
  return(individual_summary)
}

# Example usage:
final_data <- merge_regime_changes_with_individuals(gps_sub, country_data_binary)
```

## Contaminated control group

The approach above assigns indviduals to be the control group:

-   **True controls:** Individuals from countries that never experienced any regime changes

-   **Contaminated controls:** Individuals from countries that DID experience regime changes, but these individuals happen to be outside of their formative years when it occured -\> problematic, because they might have indirect exposure effect, they still lived through regime changes as adults outside of formative years

```{r deleting contaminated control group observations}
# First, identify countries that experienced ANY regime changes during your study period
countries_with_regime_changes <- country_data %>%
  filter(treatment != 0) %>%  # Any regime change (democratization or autocratization)
  distinct(country_text_id) %>%
  pull(country_text_id)

# Cleaning
final_data_clean <- final_data %>%
  mutate(
    # Create a cleaner treatment variable
    clean_treatment = case_when(
      formative_regime_change == 1 ~ 1,                    # Treated: experienced change during formative years (no need to differenciate here)
      !isocode %in% countries_with_regime_changes ~ 0,     # Pure control: from stable countries
      TRUE ~ NA_real_                                      # Contaminated: delete these
    )
  ) %>%
  filter(!is.na(clean_treatment))  # Remove contaminated controls

# Checking the new sample sizes
table(final_data_clean$clean_treatment)
```

```{r exploring the both groups}
# First approach: Country counts by treatment type
country_breakdown <- final_data_clean %>%
  group_by(first_formative_type, country) %>%
  summarise(n_individuals = n(), .groups = "drop") %>%
  arrange(first_formative_type, desc(n_individuals))

print("Country breakdown by treatment type:")
print(country_breakdown)

# Different approach: Summary table - countries per treatment type
country_summary <- final_data_clean %>%
  group_by(first_formative_type) %>%
  summarise(
    n_individuals = n(),
    n_countries = n_distinct(country),
    countries = paste(unique(country), collapse = ", "),
    .groups = "drop"
  )

print("Summary by treatment type:")
print(country_summary)

# Different approach: Focus on treated countries - which countries had which type of changes
treated_countries <- final_data_clean %>%
  filter(clean_treatment == 1) %>%
  group_by(country) %>%
  summarise(
    total_treated = n(),
    democratization = sum(formative_democratization),
    autocratization = sum(formative_autocratization),
    regime_change_type = case_when(
      democratization > 0 & autocratization == 0 ~ "Democratization only",
      autocratization > 0 & democratization == 0 ~ "Autocratization only", 
      democratization > 0 & autocratization > 0 ~ "Both types",
      TRUE ~ "Neither"
    ),
    .groups = "drop"
  ) %>%
  arrange(desc(total_treated))

print("Countries with treated individuals:")
print(treated_countries)
```

## Controls

```{r openning gdp data}
gdp_data <- read_excel(here("Input", "mpd2023_web_2.xlsx"))

```

```{r average gdppc }
# Takes a while to compute because of the nested loop
calculate_avg_gdppc <- function(final_data, gdp_data) {
  # Ensure numeric types for merging
  final_data$year_3 <- as.numeric(final_data$year_3)
  final_data$year_adult <- as.numeric(final_data$year_adult)

  # Initialize the new column
  final_data$avg_gdppc_formative <- NA

  # Loop over each row to calculate average GDP per capita during formative years
  for (i in 1:nrow(final_data)) {
    id <- final_data$id_gallup[i]  # Track respondent ID
    iso <- final_data$isocode[i]
    start_year <- final_data$year_3[i]
    end_year <- final_data$year_adult[i]

    # Subset relevant GDP data
    gdp_subset <- gdp_data[gdp_data$countrycode == iso & 
                           gdp_data$year >= start_year & 
                           gdp_data$year <= end_year, ]

    # Calculate mean GDP per capita
    avg_gdp <- mean(gdp_subset$gdppc, na.rm = TRUE)

    # Optional: Print for debugging
    # print(paste("ID:", id, "| ISO:", iso, "| Years:", start_year, "-", end_year, "| Avg GDP:", avg_gdp))

    # Assign result
    final_data$avg_gdppc_formative[i] <- avg_gdp
  }

  return(final_data)
}


final_data_gdp <- calculate_avg_gdppc(final_data_clean, gdp_data)
```

```{r average democracy index}
# Takes a while to compute because of the nested loop
calculate_avg_libdem <- function(final_data_gdp, vdem_sub) {
  # Ensure numeric types
  final_data_gdp$year_3 <- as.numeric(final_data_gdp$year_3)
  final_data_gdp$year_adult <- as.numeric(final_data_gdp$year_adult)

  # Initialize new column
  final_data_gdp$avg_libdem_formative <- NA

  # Loop over each respondent
  for (i in 1:nrow(final_data_gdp)) {
    iso <- final_data_gdp$isocode[i]
    start_year <- final_data_gdp$year_3[i]
    end_year <- final_data_gdp$year_adult[i]

    # Filter V-Dem data for the country and years
    vdem_subset <- vdem_sub[vdem_sub$country_text_id == iso & 
                            vdem_sub$year >= start_year & 
                            vdem_sub$year <= end_year, ]

    # Compute mean liberal democracy index
    avg_libdem <- mean(vdem_subset$v2x_libdem, na.rm = TRUE)

    # Assign to new column
    final_data_gdp$avg_libdem_formative[i] <- avg_libdem
  }

  return(final_data_gdp)
}

final_data_gdp <- calculate_avg_libdem(final_data_gdp, vdem_sub)


```

```{r Removing NAs from two columns}

final_data_gdp <- final_data_gdp %>%
  filter(!is.na(avg_libdem_formative) & !is.na(avg_gdppc_formative))

```

```{r assigning also a bottom threshold, eval=FALSE, include=FALSE}
# Assigning observations as treated only if they were older than 2 years in year of regime change
final_data_gdp$formative_regime_change[final_data_gdp$age_at_regime_change < 3] <- 0
table(final_data_gdp$formative_regime_change)


 final_data_gdp <- final_data_gdp %>% mutate(years_spend_regimes = age - age_at_regime_change)

```
