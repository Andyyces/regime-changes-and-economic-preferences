---
title: "Data wragling"
date: "2025-04-20"
output: html_document
---

# Loading

```{r loading packages, include=FALSE}
#install.packages("pacman")
library(pacman)
p_load(haven,
       here,
       stargazer,
       summarytools,
       readxl,
       dplyr,
       lubridate,
       ggplot2,
       vdemdata,
       summarytools,
       devtools,
       zoo,
       tidyverse)

#install.packages("summarytools")
#install.packages("devtools")
#devtools::install_github("vdeminstitute/vdemdata")


#Vdem data 
vdem <- vdemdata::vdem

#opening datasets (individual survey)
unzip(here("Input","GPS_Dataset.zip"))
unzip(here("Input", "GPS_dataset_individual_level.zip"))
GPS_indiv <- read_dta(here("Input","individual_v11_new.dta"))

#openning data polity
p5 <- read_excel(here("Input", "p5v2018.xls"))

#converting the column encodings to UTF-8
names(GPS_indiv)
GPS_indiv <- GPS_indiv %>%
  mutate(across(where(is.character), ~ iconv(., from = "", to = "UTF-8")))

view(dfSummary(GPS_indiv))
view(dfSummary(p5))
#view(dfSummary(vdem))  #Takes very long to compute

```

# Data wrangling

Questions for meeting on 29.04. :

-   **How to decide on a threshold of assigning *generate_regime_change*?** So far, we have been working with liberal democracy index from V-Dem, but there are more options -\> should we aggregate them into one?

    *answer whether its a sudden change or linear -\> which are better suited?*

*Restrict just to one schock: autoritative -\> democratic*

-   **Separate model for each preference / try to combine them?** *check for literature- maybe choose 2 based on this, if we use all of them, Lessmann will ask about multiple hypotheses testing :)*

*time, age, cohort fixed effects*

*age/cohort effects could be problematic*

*net out age effect from economic preferences -\>whats the effect of risk aversion? (next step)*

*if not DiD: mean comparisons -\> give up on causal effects -\> more about living under regime than regime changes -\>already dome evidence on this*

```{r}
#selecting necessary columns
vdem_sub <- vdem %>%
  select(country_name,country_text_id, year, v2x_libdem)

#calculating birth_years and selecting necessary columns
gps_sub <- GPS_indiv %>%
  mutate(birth_year = year(date) - age ) %>% mutate(year_3= birth_year + 3) %>% 
  select(id_gallup, age , date, country,isocode, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender, birth_year, year_3)

gps_sub <- gps_sub %>%
  mutate(year = year(date)) %>% select(!date)

#Imagine the person faced with democracy at 18
gps_sub <- gps_sub %>%
  mutate(year_adult = birth_year + 18) 

gps_sub <- gps_sub %>%
  rename(interview_year = year)

#Keeping just complete cases and saving the observations containing NA's as a separate dataframe
gps_NA <- gps_sub %>%
  filter(!complete.cases(.))

gps_sub <- gps_sub %>%
  drop_na()

```

## Treatment

Problem: Just the FIRST regime changes considered -\> working on this, will finish on 23.05.

### First step: regime changes on country level

```{r regime changes periods on country level}
# Function to create country-level regime change data
create_country_regime_data <- function(democracy_data, threshold = 0.05, country_filter = NULL) {
  
  # Filter for specific countries if provided
  if (!is.null(country_filter)) {
    democracy_data <- democracy_data %>%
      filter(country_text_id %in% country_filter)
  }
  
  # First, identify regime changes at country level
  country_regime_changes <- democracy_data %>%
    group_by(country_text_id) %>%
    arrange(year) %>%
    mutate(
      # Calculate rolling standard errors for confidence intervals
      v2x_libdem_rolling_sd = rollapply(v2x_libdem, width = 5,
                                       FUN = function(x) sd(x, na.rm = TRUE),
                                       fill = NA, align = "center"),
      v2x_libdem_rolling_n = rollapply(v2x_libdem, width = 5,
                                      FUN = function(x) sum(!is.na(x)),
                                      fill = NA, align = "center"),
      
      # Calculating confidence intervals
      country_sd = sd(v2x_libdem, na.rm = TRUE),
      country_n = n(),
      
      v2x_libdem_se = case_when(
        !is.na(v2x_libdem_rolling_sd) & v2x_libdem_rolling_n > 1 ~
          v2x_libdem_rolling_sd / sqrt(v2x_libdem_rolling_n),
        TRUE ~ country_sd / sqrt(country_n)
      ),
      
      df = case_when(
        !is.na(v2x_libdem_rolling_n) & v2x_libdem_rolling_n > 1 ~
          v2x_libdem_rolling_n - 1,
        TRUE ~ country_n - 1
      ),
      
      t_stat = qt(0.975, df = df),
      ci_lower = v2x_libdem - t_stat * v2x_libdem_se,
      ci_upper = v2x_libdem + t_stat * v2x_libdem_se,
      
      # Look at 10-year changes
      libdem_diff = v2x_libdem - lag(v2x_libdem, 10),
      ci_lower_lag10 = lag(ci_lower, 10),
      ci_upper_lag10 = lag(ci_upper, 10),
      
      # Check for non-overlapping confidence intervals
      ci_non_overlapping = case_when(
        is.na(ci_lower) | is.na(ci_upper_lag10) ~ 0,
        ci_lower > ci_upper_lag10 | ci_upper < ci_lower_lag10 ~ 1,
        TRUE ~ 0
      ),
      
      # Identify regime changes
      regime_change = ifelse(ci_non_overlapping == 1 & 
                            !is.na(libdem_diff) & 
                            abs(libdem_diff) > threshold, 1, 0),
      
      # Create treatment variable with 3 categories
      treatment = case_when(
        regime_change == 1 & libdem_diff > 0 ~ 2,  # Democratization
        regime_change == 1 & libdem_diff < 0 ~ 1,  # Autocratization
        TRUE ~ 0  # No regime change
      ),
      
      # Create factor with labels
      treatment_factor = factor(treatment,
                               levels = c(0, 1, 2),
                               labels = c("No change", "Autocratization", "Democratization"))
    ) %>%
    select(country_text_id, country_name, year, v2x_libdem, treatment, treatment_factor)
  
  return(country_regime_changes)
}

# Get unique countries from gps_sub
countries_to_analyze <- unique(gps_sub$isocode)

# Create the country-level data for selected countries only
country_data <- create_country_regime_data(vdem_sub, 
                                         threshold = 0.2,
                                         country_filter = countries_to_analyze)

# Filter for periods after 1920
country_data <- country_data %>%
  filter(year > 1910)

# For multiple treatment categories, we need to create separate binary indicators
# Creating binary indicators for each treatment type
country_data_binary <- country_data %>%
  mutate(
    autocratization = ifelse(treatment == 1, 1, 0),
    democratization = ifelse(treatment == 2, 1, 0),
    any_change = ifelse(treatment != 0, 1, 0)
  )
```

### Second step: connecting with GPS data

### Previous approach

Problem:only first regime changes period is considered in every country, function too long and complicated -\> simplify and split into two steps

```{r separating the treatment and control groups with custom function}
generate_formative_regime_change <- function(democracy_data, gps_data, threshold = 0.05) {
  # Processing democracy_data to compute confidence intervals and identify regime changes
  vdem_with_ci <- democracy_data %>%
    group_by(country_text_id) %>%
    arrange(year) %>%
    mutate(
      # Calculate rolling standard errors for confidence intervals
      v2x_libdem_rolling_sd = rollapply(v2x_libdem, width = 5, 
                                      FUN = function(x) sd(x, na.rm = TRUE),
                                      fill = NA, align = "center"),
      v2x_libdem_rolling_n = rollapply(v2x_libdem, width = 5, 
                                     FUN = function(x) sum(!is.na(x)),
                                     fill = NA, align = "center"),
      
      # Calculating confidence intervals
      country_sd = sd(v2x_libdem, na.rm = TRUE),
      country_n = n(),
      
      v2x_libdem_se = case_when(
        !is.na(v2x_libdem_rolling_sd) & v2x_libdem_rolling_n > 1 ~ 
          v2x_libdem_rolling_sd / sqrt(v2x_libdem_rolling_n),
        TRUE ~ country_sd / sqrt(country_n)
      ),
      
      df = case_when(
        !is.na(v2x_libdem_rolling_n) & v2x_libdem_rolling_n > 1 ~ 
          v2x_libdem_rolling_n - 1,
        TRUE ~ country_n - 1
      ),
      
      t_stat = qt(0.975, df = df),  # For 95% CI
      ci_lower = v2x_libdem - t_stat * v2x_libdem_se,
      ci_upper = v2x_libdem + t_stat * v2x_libdem_se
    )
  
  # Processing to identify regime changes
  regime_change_years <- vdem_with_ci %>%
    arrange(country_text_id, year) %>%
    group_by(country_text_id) %>%
    mutate(
      libdem_diff = v2x_libdem - lag(v2x_libdem, 10),  # 10-year change
      ci_lower_lag10 = lag(ci_lower, 10),
      ci_upper_lag10 = lag(ci_upper, 10),
      
      # Checking if confidence intervals don't overlap AND change exceeds threshold
      ci_non_overlapping = case_when(
        is.na(ci_lower) | is.na(ci_upper_lag10) ~ 0,
        ci_lower > ci_upper_lag10 | ci_upper < ci_lower_lag10 ~ 1,
        TRUE ~ 0
      ),
      
      # This is now 1 for regime changes, 0 for non-regime changes
      formative_regime_change = ifelse(ci_non_overlapping == 1 & !is.na(libdem_diff) & abs(libdem_diff) > threshold, 1, 0),
      
      # Direction of change (only for regime changes)
      regime_change_direction = case_when(
        formative_regime_change == 1 & libdem_diff > 0 ~ "democratization",
        formative_regime_change == 1 & libdem_diff < 0 ~ "autocratization",
        TRUE ~ NA_character_
      ),
      autocratization_period = ifelse(formative_regime_change == 1 & libdem_diff < 0, 1, 0),
      democratization_period = ifelse(formative_regime_change == 1 & libdem_diff > 0, 1, 0)
    ) %>%
    # Keeping ALL observations
    select(country_name, country_text_id, regime_change_year = year, 
           libdem_diff, formative_regime_change,
           regime_change_direction,
           autocratization_period,
           democratization_period)
  
  # Joining with individual level data and checking for formative years overlap
  result <- gps_data %>%
    left_join(regime_change_years, 
              by = c("isocode" = "country_text_id"), 
              relationship = "many-to-many") %>%
    # Creating a temporary variable to identify formative regime changes
    mutate(
      is_formative_regime_change = formative_regime_change == 1 & 
                                  regime_change_year >= year_3 & 
                                  regime_change_year < year_adult
    ) %>%
    # First identifying individuals with formative regime changes
    group_by(id_gallup) %>%
    mutate(
      has_formative_change = any(is_formative_regime_change, na.rm = TRUE),
      first_formative_year = ifelse(has_formative_change, 
                                   min(regime_change_year[is_formative_regime_change], na.rm = TRUE), 
                                   NA_real_),
      n_autocratization_periods = sum(is_formative_regime_change & autocratization_period == 1, na.rm = TRUE),
      n_democratization_periods = sum(is_formative_regime_change & democratization_period == 1, na.rm = TRUE)
    ) %>%
    # Now extracting details for the first formative regime change
    filter(is.na(first_formative_year) | regime_change_year == first_formative_year) %>%
    summarize(
      # Basic information
      formative_regime_change = as.numeric(first(has_formative_change)),
      # Remove birth_year since it's already in gps_data
      
      # Details of the first regime change (if any)
      formative_change_year = ifelse(formative_regime_change == 1, 
                                    first(regime_change_year[is_formative_regime_change]), 
                                    NA_real_),
      
      formative_change_direction = ifelse(formative_regime_change == 1, 
                                         first(regime_change_direction[is_formative_regime_change]), 
                                         NA_character_),
      
      formative_change_magnitude = ifelse(formative_regime_change == 1, 
                                         first(libdem_diff[is_formative_regime_change]), 
                                         NA_real_),
      
      # Calculate age at regime change (use birth_year from original data)
      age_at_regime_change = ifelse(formative_regime_change == 1 & !is.na(formative_change_year), 
                                   formative_change_year - first(birth_year), 
                                   NA_real_),
      n_autocratization_periods = first(n_autocratization_periods),
      n_democratization_periods = first(n_democratization_periods)
    ) %>%
    ungroup()
  
  # Merging with original individual data to keep all variables
  gps_data %>%
    left_join(result, by = "id_gallup")
}

# Applying the function
final_data <- generate_formative_regime_change(vdem_sub, gps_sub, threshold = 0.25)
table(final_data$formative_regime_change)
```

## Controls

```{r openning gdp data}
gdp_data <- read_excel(here("Input", "mpd2023_web_2.xlsx"))

```

```{r average gdppc }
# Takes a while to compute because of the nested loop
calculate_avg_gdppc <- function(final_data, gdp_data) {
  # Ensure numeric types for merging
  final_data$year_3 <- as.numeric(final_data$year_3)
  final_data$year_adult <- as.numeric(final_data$year_adult)

  # Initialize the new column
  final_data$avg_gdppc_formative <- NA

  # Loop over each row to calculate average GDP per capita during formative years
  for (i in 1:nrow(final_data)) {
    id <- final_data$id_gallup[i]  # Track respondent ID
    iso <- final_data$isocode[i]
    start_year <- final_data$year_3[i]
    end_year <- final_data$year_adult[i]

    # Subset relevant GDP data
    gdp_subset <- gdp_data[gdp_data$countrycode == iso & 
                           gdp_data$year >= start_year & 
                           gdp_data$year <= end_year, ]

    # Calculate mean GDP per capita
    avg_gdp <- mean(gdp_subset$gdppc, na.rm = TRUE)

    # Optional: Print for debugging
    # print(paste("ID:", id, "| ISO:", iso, "| Years:", start_year, "-", end_year, "| Avg GDP:", avg_gdp))

    # Assign result
    final_data$avg_gdppc_formative[i] <- avg_gdp
  }

  return(final_data)
}


final_data_gdp <- calculate_avg_gdppc(final_data, gdp_data)


```

```{r average democracy index}
# Takes a while to compute because of the nested loop
calculate_avg_libdem <- function(final_data_gdp, vdem_sub) {
  # Ensure numeric types
  final_data_gdp$year_3 <- as.numeric(final_data_gdp$year_3)
  final_data_gdp$year_adult <- as.numeric(final_data_gdp$year_adult)

  # Initialize new column
  final_data_gdp$avg_libdem_formative <- NA

  # Loop over each respondent
  for (i in 1:nrow(final_data_gdp)) {
    iso <- final_data_gdp$isocode[i]
    start_year <- final_data_gdp$year_3[i]
    end_year <- final_data_gdp$year_adult[i]

    # Filter V-Dem data for the country and years
    vdem_subset <- vdem_sub[vdem_sub$country_text_id == iso & 
                            vdem_sub$year >= start_year & 
                            vdem_sub$year <= end_year, ]

    # Compute mean liberal democracy index
    avg_libdem <- mean(vdem_subset$v2x_libdem, na.rm = TRUE)

    # Assign to new column
    final_data_gdp$avg_libdem_formative[i] <- avg_libdem
  }

  return(final_data_gdp)
}

final_data_gdp <- calculate_avg_libdem(final_data_gdp, vdem_sub)

```

```{r Removing NAs from two columns}

final_data_gdp <- final_data_gdp %>%
  filter(!is.na(avg_libdem_formative) & !is.na(avg_gdppc_formative))

```

```{r assigning also a bottom threshold}
# Assigning observations as treated only if they were older than 2 years in year of regime change
final_data_gdp$formative_regime_change[final_data_gdp$age_at_regime_change < 3] <- 0
table(final_data_gdp$formative_regime_change)


 final_data_gdp <- final_data_gdp %>% mutate(years_spend_regimes = age - age_at_regime_change)

```
