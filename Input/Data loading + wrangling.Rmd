---
title: "Data wragling"
author: "Elvin Mammadov"
date: "2025-04-20"
output: html_document
---

## Preparation: data + packages

```{r loading packages, include=FALSE}
#install.packages("pacman")
library(pacman)
p_load(haven,
       here,
       stargazer,
       summarytools,
       readxl,
       dplyr,
       lubridate,
       ggplot2,
       vdemdata,
       summarytools,
       devtools)

#install.packages("summarytools")
#install.packages("devtools")
#devtools::install_github("vdeminstitute/vdemdata")


#Vdem data 
vdem <- vdemdata::vdem

#opening datasets (individual survey)
unzip(here("Input","GPS_Dataset.zip"))
unzip(here("Input", "GPS_dataset_individual_level.zip"))
GPS_indiv <- read_dta(here("Input","individual_v11_new.dta"))

#openning data polity
p5 <- read_excel(here("Input", "p5v2018.xls"))

#converting the column encodings to UTF-8
names(GPS_indiv)
GPS_indiv <- GPS_indiv %>%
  mutate(across(where(is.character), ~ iconv(., from = "", to = "UTF-8")))

view(dfSummary(GPS_indiv))
view(dfSummary(p5))
#view(dfSummary(vdem))  #Takes very long to compute

```

## Data wrangling

Questions for meeting on 29.04. :

-   **How to decide on a threshold of assigning *generate_regime_change*?** So far, we have been working with liberal democracy index from V-Dem, but there are more options -\> should we aggregate them into one?

    *answer whether its a sudden change or linear -\> which are better suited?*

-   **New variable capturing the "formative years" -\> 18 years of age? Or younger? -\> Only assign treatment if regime changed in this time?** Yes, do it. If regime change until 25 years (1) -\> treated, if not -\> not treated (0)

-   Adding another variable capturing the **exposure** to different political regime over a very **long time horizon** -\> might influence the resident's economic preferences. Similar approach in paper @friehe_time_2020 *No, dont do this*

*Restrict just to one schock: autoritative -\> democratic*

-   Adding interaction term $TimeToTreatment_{c,t,k}$ as an indicator for being $k$ **periods away from the treatment** (regime change) in country $c$ at time $t$?

-   **Separate model for each preference / try to combine them?** *check for literature- maybe choose 2 based on this, if we use all of them, Lessmann will ask about multiple hypotheses testing :)*

-   *potential counfounder: economic outcomes -\> include GDP data per year*

*time, age, cohort fixed effects*

*age/cohort effects could be problematic*

*net out age effect from economic preferences -\>whats the effect of risk aversion? (next step)*

*submit .dta*

*if not DiD: mean comparisons -\> give up on causal effects -\> more about living under regime than regime changes -\>already dome evidence on this*

```{r}
#selecting necessary columns
vdem_sub <- vdem %>%
  select(country_name, year, v2x_libdem)

#calculating birth_years and selecting necessary columns
gps_sub <- GPS_indiv %>%
  mutate(birth_year = year(date) - age) %>%
  select(id_gallup, age , date, country, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender, birth_year)


gps <- gps_sub %>%
  mutate(year = year(date)) %>% select(!date)



#creating regime change function
generate_regime_change <- function(data, threshold) {
  data %>%
    arrange(country_name, year) %>%
    group_by(country_name) %>%
    mutate(
      libdem_diff = v2x_libdem - lag(v2x_libdem),
      regime_change = ifelse(libdem_diff > threshold, 1, 0)
    ) %>%
    ungroup()
}

#then applying this function to our data , *threshold* is example, this number can be different.
vdem_with_regimes <- generate_regime_change(vdem_sub, threshold = 0.03)
head(vdem_with_regimes)


#Imagine the person faced with democracy at 25
gps <- gps %>%
  mutate(year_adult = birth_year + 25) # Maybe we should base this decision (whether 25 any different age) on some literature? I will take a look.

gps <- gps %>%
  rename(interview_year = year)



#This approach end up with some NA, I think it is assigning 1 only if the regime change happens in the year_adult -> does not capture the whole time period from birth until year_adult
```

```{r}
# Function to identify if individuals experienced regime change during formative years
generate_formative_regime_change <- function(democracy_data, gps_data, threshold) {
  # Processing democracy data to identify regime changes (same like previous)
  regime_change_years <- vdem_sub %>%
    arrange(country_name, year) %>%
    group_by(country_name) %>%
    mutate(
      libdem_diff = v2x_libdem - lag(v2x_libdem), # this approach does not capture linear change over few years, just sudden changes between years -> problematic? Maybe we can take into account a cumulative change over k years, to better separate the countries? Let's discuss :)
      regime_change = ifelse(libdem_diff > threshold, 1, 0)) %>%
  # filtering just for countries that experienced a regime change
    filter(regime_change == 1) %>%
    select(country_name, regime_change_year = year)
  
# Joining with individual level data and checking for formative years overlap
  result <- gps %>%
    left_join(regime_change_years,
            by = c("country" = "country_name"),
            relationship = "many-to-many") %>%
    group_by(id_gallup) %>% # unique identifier for individuals
    summarize(
      formative_regime_change = as.numeric(
      # This will be TRUE only if at least one regime change falls within formative years
      # It will be FALSE if there are no regime changes or if none fall within the range
      # The as.numeric() converts TRUE to 1 and FALSE to 0
        any(regime_change_year >= birth_year & 
              regime_change_year <= year_adult, 
            na.rm = TRUE)
        )
      ) %>%
    ungroup()

# Merge back with original individual data to keep all variables
  gps %>%
    left_join(result, by = "id_gallup")
}

# Applying the function
final_data <- generate_formative_regime_change(vdem_data, gps, threshold = 0.03)

# Checking how many individuals is in each group
table(final_data$formative_regime_change)
```

```{r merging final data with gdp pc data}
gdp_data <- read_excel(here("Input", "mpd2023_web_2.xlsx"))

gdp_data <- gdp_data %>% 
  filter(year== 2012 | year== 2013)


final_data_gdp <- final_data %>%
  left_join(gdp_data %>% select(country, year, gdppc),
            by = c("country" = "country", "interview_year" = "year"))

```

```{r simple reg}
c <-lm(trust ~ formative_regime_change + subj_math_skills + gender + log(gdppc), data = final_data_gdp)

summary(c)




#plot


ggplot(final_data_gdp, aes(x = factor(formative_regime_change), y = trust)) +
  geom_boxplot(fill = "skyblue") +
  labs(
    x = "Formative Regime Change (0 = No, 1 = Yes)",
    y = "Trust",
    title = "Trust levels by Regime Change Exposure"
  )




```

### EDA

```{r}
#package for staggered DiD
#install.packages("did")
library(did)

#devtools::install_github("jonathandroth/pretrends")
library(pretrends)
```

### Econometric model

Meeting on 29.04.: try different estimators and compare the robustness -\> then decide which one is the best

**Method**: **staggered DiD** (to account for time-varying treatment assignment)

$$Y_{ict} = \beta_0 + \sum_{k} \beta_{1k}(RegimeChange_{c,t-k}) + \beta_2 X\_{ict} + \gamma_c + \delta_t + \theta_a + \varepsilon_{ict}$$ where:

$Y_{ict}$ represents the economic preference outcome (trust, risk-taking, patience, etc.) for individual $i$ in country $c$ at time $t$

$RegimeChange_{c,t-k}$ is a variable indicating whether a country $c$ experienced a regime change $k$ periods before time $t$

$X_{ict}$ is a vector of individual-level control variables (gender, math skills)

$\gamma_c$ represents country fixed effects

$\delta_t$ represents time/year fixed effects

$\theta_a$ represents **age group/cohort** fixed effects

$\varepsilon_{ict}$ is the error term
