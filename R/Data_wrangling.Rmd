---
title: "Data wragling"
date: "2025-04-20"
output: html_document 
---

# Data loading

```{r Loading the Data}

library(pacman)
p_load(haven,
       here,
       stargazer,
       summarytools,
       readxl,
       dplyr,
       lubridate,
       ggplot2,
       vdemdata,
       summarytools,
       devtools,
       zoo,
       tidyverse)


source(here("R", "Script", "01_data_loading.R"))

```

# Data wrangling

```{r}
source(here("R", "Script", "02_filtering.R"))
```

## Treatment calculation

### First step: identifying regime changes on country level

```{r regime changes periods on country level}
source(here("R", "Script", "03_regime_changes_function.R"))
```

### Second step: connecting with GPS data

```{r}
source(here("R", "Script", "04_merging_GPS_vdem.R"))
```

## Contaminated control group

The approach above assigns following individuals to be part of the control group:

-   **True controls:** Individuals from countries that never experienced any regime changes

-   **Contaminated controls:** Individuals from countries that did experience regime changes, but these individuals happen to be outside of their formative years when it occured -\> problematic, because they might have indirect exposure effect, they still lived through regime changes as adults outside of formative years. The following part of the code removes these individuals from out dataset.

```{r exploring the both groups}
source(here("R", "Script", "05_exploring_both_groups.R"))
```

# Calculating controls

The following code takes a bit longer to generate because of a necessary nested loop structure. It calculates the following controls:

-   Average GDP in the country of residence during formative years of the individual (3-18 years)

-   Average LDI (Liberal Democracy Index) in the country of residence during formative years of the individual (3-18 years)

```{r average gdppc and democracy index}

source(here("R", "Script", "06_average_gdppc_index.R"))
```

During the robustness check, we explored our options how to add more controls. In the following part of the code we include:

-   Dummy for a recession during formative years

The recession is calculated based on country-specific volatility

```{r recession dummy}

source(here("R", "Script", "07_recession_dummy.R"))
```

# Saving the datasets in RDS format

```{r}
# Saving the final datasets in rds format
# data all osbervations
saveRDS(final_data, here("Input","clean", "final_data.rds"))

# data filtered observations with controls
saveRDS(final_data_gdp, here("Input","clean", "final_data_gdp.rds"))

# data filtered observations with controls
saveRDS(final_data_clean, here("Input","clean", "final_data_clean.rds"))

# country summary data for tables in Milestone 3 report
saveRDS(country_summary, here("Input","clean", "country_summary.rds"))

# country data data for regime change visualization
saveRDS(country_data, here("Input","clean", "country_data.rds"))

```
