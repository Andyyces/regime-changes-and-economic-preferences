---
title: "Regime Changes and Economic Preferences: Global Evidence"
subtitle: "Milestone 5: Robustness"
author: "Andrea Češková and Elvin Mammadov"
format: 
  pdf:
    reference-location: document
number-sections: true
toc: true
crossref:
  fig-title: "Figure"
  tbl-title: "Table"
  eq-title: "Equation"
  lot-title: "List of figures"
bibliography: references.bib
link-citations: true
---

```{r}
#| message: false
#| warning: false
#| include: false
library(pacman)

p_load(gt,
       knitr,
       kableExtra,
       dplyr,
       stargazer,
       here
       )
```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
#  Load the function from extract_codes.R
script_files <- list.files(
  path = here("R", "Script"),
  pattern = "\\.R$",
  full.names = TRUE
)

# Hamısını source et
walk(script_files, source)
```

```{r}
#| include: false
conditional_balance <- readRDS(here("Output", "Tables", "conditional_balance_table.rds"))
democratization_balance <- readRDS(here("Output", "Tables", "balance_table_democratization_vs_autocratization.rds"))
overall_balance <- readRDS(here("Output", "Tables", "balance_table_overall.rds"))
sample_composition <- readRDS(here("Output", "Tables", "sample_composition.rds"))
clustering_results <- readRDS(here("Output", "Robustness", "clustering_results.rds"))
```

```{r}
#| message: false
#| warning: false
#| include: false
demo_summary <- clustering_results$demo_summary
auto_summary <- clustering_results$auto_summary
```

# Sample composition

Our final analytical sample consists of `r sum(sample_composition$n)` individuals across three groups:

```{r}
#| echo: false
#| label: tbl-samplecomp
#| tbl-cap: "Sample Composition by Treatment Type"
#| tbl-pos: "h"
sample_composition %>%
  kable(format = "latex",
        digits = 2,
        col.names = c("Group", "N", "Proportion", "Percentage")) %>%
  kable_styling(latex_options = c("striped")) %>%
  footnote(general = "Distribution of observations across control and treatment groups.",
           general_title = "Note:")
```

# Different specification

## Clustering of standard errors

Our baseline specification clusters standard errors at the country level, reflecting our assumption that the primary source of correlation in errors stems from shared country-specific factors such as cultural norms, institutional quality, and historical experiences. To assess the robustness of our inference, we examine how our results change under alternative clustering assumptions.

In this chapter we present sensitivity analysis across four clustering methods: **country-level clustering (our baseline)**, **two-way clustering by country and birth cohort**, **regional clustering**, and **birth cohort clustering**. We chose to analyse only our baseline specification. @tbl-cluster_democ shows the results for base specification: democratization and @tbl-cluster_autoc for base specification: autocratization.

```{r}
#| message: false
#| warning: false
#| include: false

# Function to create professional clustering tables for PDF
create_clustering_table_pdf <- function(summary_data, treatment_type) {
  
  summary_data$preference <- c("Patience", "Risk taking", "Positive Reciprocity", "Negative Reciprocity", "Altruism", "Trust")
  # Clean up column names to match your report style
  colnames(summary_data) <- c("", "Country", "Two-way", "Region", "Cohort")
  
  # Create the table for PDF/LaTeX output
  table <- summary_data %>%
    kable(format = "latex", 
          align = c("l", "c", "c", "c", "c"),
          escape = FALSE) %>%
    kable_styling(
      latex_options = c("striped", "scale_down"),
      full_width = FALSE,
      position = "center",
      font_size = 10
    ) %>%
    row_spec(0, bold = TRUE) %>%
    column_spec(1, width = "4cm", bold = FALSE) %>%
    column_spec(2:5, width = "2cm") %>%
    add_header_above(c(" " = 1, "Clustering Method" = 4), bold = TRUE) %>%
    footnote(
      general = "Standard errors clustered as indicated in column headers. All models include region and birth year fixed effects.",
      general_title = "Note:",
      footnote_as_chunk = TRUE,
      threeparttable = TRUE
    )
  
  return(table)
}

```

The patience affect in @tbl-cluster_democ remains stable across all clustering methods, with standard errors ranging from 0.0207 to 0.0262, maintaining significance at the 5% level or better. This consistency provides **strong evidence** that our main finding—**experiencing democratization during formative years increases patience**—is not just because of our choice of one clustering method.

The similarity between standard errors under country-level (0.025) and two-way clustering (0.024) indicates minimal temporal correlation within countries. Regional clustering yields slightly larger standard errors, as expected given the smaller number of clusters, while cohort clustering produces the smallest standard errors.

Notably, the **altruism coefficient** exhibits sensitivity to the clustering method. While the point estimate remains stable at -0.078, it is insignificant under country clustering but becomes **highly significant (p \< 0.001)** under **cohort clustering**. This pattern suggests that altruism preferences exhibit **stronger within-country correlation than within-cohort correlation** - in other words, individuals within the same country are more similar to each other in their altruism preferences than individuals born in the same year globally. This likely reflects the importance of country-specific cultural transmission mechanisms in shaping other-regarding preferences.

```{r}
#| echo: false
#| label: tbl-cluster_democ
#| tbl-cap: "Sensitivity to Clustering Approaches - Democratization Effects"
#| tbl-pos: h
demo_table_pdf <- create_clustering_table_pdf(demo_summary, 
                                              "democratization")

demo_table_pdf
```

Results in @tbl-cluster-autoc how generally weaker effects across all clustering methods, consistent with our main findings. The marginal significance of positive reciprocity is relatively stable across specifications, while other effects remain statistically insignificant regardless of clustering approach.

```{r}
#| echo: false
#| label: tbl-cluster-autoc
#| tbl-cap: "Sensitivity to Clustering Approaches - Autocratization Effects"
#| tbl-pos: h
auto_table_pdf <- create_clustering_table_pdf(auto_summary, 
                                              "autocratization")
auto_table_pdf
```

Overall, these robustness checks strengthen confidence in our core findings while highlighting which results are sensitive to different clustering approaches. The **persistence of the democratization-patience relationship** across all specifications underscores its robustness as our primary empirical contribution.

## Definition of formative age

# Balancing tests

## Conditional Balance Tests (Primary Identification Test)

The following TWFE examines whether treatment assignment is random conditional on our fixed effects.

```{r}
#| echo: false
conditional_balance %>%
  kbl(format = "latex", 
        caption = "Conditional Balance Tests (Residualized Variables)",
        booktabs = TRUE,
        digits = 4) %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down")) %>%
  footnote(general = "Variables residualized with respect to region and birth year fixed effects. *** p<0.001, ** p<0.01, * p<0.05, + p<0.1",
           general_title = "Note:")
```

The conditional balance tests show no evidence of systematic selection , strongly supporting the validity of our identification strategy.

## Overall Treatment vs Control Balance (Descriptive)

As expected, countries that experienced regime changes differ systematically from stable countries:

```{r}
#| echo: false
overall_balance %>%
  kable(format = "latex",
        caption = "Overall Balance: Any Treatment vs Control",
        booktabs = TRUE,
        digits = 3,
        col.names = c("Variable", "Control Mean (SD)", "Treated Mean (SD)", 
                     "Difference [95% CI]", "t-statistic", "p-value", "Sig.")) %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  footnote(general = "Large differences expected and do not threaten identification. Our fixed effects strategy accounts for these systematic differences.",
           general_title = "Note:")
```

## Treatment Type Comparison

Within the treated sample, we examine balance between democratization and autocratization:

```{r}
#| echo: false
democratization_balance %>%
  kable(format = "latex",
        caption = "Balance Tests: Democratization vs Autocratization",
        booktabs = TRUE,
        digits = 3) %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  footnote(general = "Mean (SD) for control variables within treated sample. *** p<0.001, ** p<0.01, * p<0.05, + p<0.1",
           general_title = "Note:")
```

balance_table_overall

# Different Datasets

## V-dem: Regime of the World Index

### Base Specification with Heterogenous Effects

### Specification with Controls

## Polity dataset

### Base Specification with Heterogenous Effects

### Specification with Controls
