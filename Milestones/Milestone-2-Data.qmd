---
title: "Regime Changes and Economic Preferences: Global Evidence"
subtitle: "Milestone 2: Data"
author: "Andrea Češková and Elvin Mammadov"
crossref:
  fig-title: "Figure"
  lot-title: "List of figures"
bibliography: references.bib
format: 
  pdf:
    reference-location: document
---

```{r}
#| label: setup
#| include: false
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load(tidyverse,
       patchwork,
       ggthemes,
       haven,
       here,
       stargazer,
       summarytools,
       readxl,
       dplyr,
       lubridate,
       ggplot2,
       vdemdata,
       tidyr,
       RplotExtra,
       gt,
       cowplot,
       pacman,
       gridExtra,
       RColorBrewer,
       effectsize,
       kableExtra,
       knitr,
       sf,
       rnaturalearth,
       rnaturalearthdata,
       viridis,
       broom,
       viridis)

vdem <- vdemdata::vdem

#opening datasets (individual survey)
unzip(here("Input","GPS_Dataset.zip"))
unzip(here("Input", "GPS_dataset_individual_level.zip"))
GPS_indiv <- read_dta(here("Input","individual_v11_new.dta"))
GPS_indiv <- GPS_indiv %>%
  mutate(across(where(is.character), ~ iconv(., from = "", to = "UTF-8")))
#selecting necessary columns
vdem_sub <- vdem %>%
  select(country_name,country_text_id, year, v2x_libdem)

#calculating birth_years and selecting necessary columns
gps_sub <- GPS_indiv %>%
  mutate(birth_year = year(date) - age) %>%
  select(id_gallup, age , date, country,isocode, region, patience, risktaking, posrecip, negrecip, altruism, trust, subj_math_skills, gender, birth_year)

gps <- gps_sub %>%
  mutate(year = year(date)) %>% select(!date)
gps <- gps %>%
  mutate(year_adult = birth_year + 21) # Maybe we should base this decision (whether 25 any different age) on some literature? I will take a look.

gps <- gps %>%
  rename(interview_year = year)
# Function to identify if individuals experienced regime change during formative years
# Function to identify if individuals experienced regime change during formative years
generate_formative_regime_change <- function(democracy_data, gps_data, threshold) {
  # Processing democracy data to identify regime changes (same like previous)
  regime_change_years <- vdem_sub %>%
    arrange(country_text_id, year) %>%
    group_by(country_text_id) %>%
    mutate(
      libdem_diff = v2x_libdem - lag(v2x_libdem), # this approach does not capture linear change over few years, just sudden changes between years -> problematic? Maybe we can take into account a cumulative change over k years, to better separate the countries? Let's discuss :)
      regime_change = ifelse(libdem_diff > threshold, 1, 0)) %>%
  # filtering just for countries that experienced a regime change
    filter(regime_change == 1) %>%
    select(country_name, regime_change_year = year)
  
# Joining with individual level data and checking for formative years overlap
  result <- gps %>%
    left_join(regime_change_years,
            by = c("isocode" = "country_text_id"),
            relationship = "many-to-many") %>%
    group_by(id_gallup) %>% # unique identifier for individuals
    summarize(
      formative_regime_change = as.numeric(
      # This will be TRUE only if at least one regime change falls within formative years
      # It will be FALSE if there are no regime changes or if none fall within the range
      # The as.numeric() converts TRUE to 1 and FALSE to 0
        any(regime_change_year >= birth_year & 
              regime_change_year <= year_adult, 
            na.rm = TRUE)
        )
      ) %>%
    ungroup()

# Merge back with original individual data to keep all variables
  gps %>%
    left_join(result, by = "id_gallup")
}

# Applying the function
final_data <- generate_formative_regime_change(vdem_sub, gps, threshold = 0.03)


gdp_data <- read_excel(here("Input", "mpd2023_web_2.xlsx"))

gdp_data <- gdp_data %>% 
  filter(year== 2012 | year== 2013)


final_data_gdp <- final_data %>%
  left_join(gdp_data %>% select(countrycode, year, gdppc),
            by = c("isocode" = "countrycode", "interview_year" = "year"))

final_data_gdp <- na.omit(final_data_gdp)

```

# Sources

In our project, we are making use of 3 datasets:

-   Vdem (@coppedge_v-dem_2025) dataset comes also as an R package:`vdemdata`. This dataset contains various democracy indicators for 202 countries starting of year 1789. We will be using the **Liberal democracy index which** combines many of these indicators into a single number for each country/year.

-   Global Preference Survey (@falk_global_2018) dataset was downloaded as a ZIP file from the [following website](https://gps.iza.org/downloads). This dataset contains information about economic preferences of 80337 individuals from 76 countries. The survey was conducted between 2012 and 2013.

-   Data on country's GDP's was downloaded from the [Maddison Project Database 2023](https://www.rug.nl/ggdc/historicaldevelopment/maddison/releases/maddison-project-database-2023) (@bolt_maddison-style_2025). This dataset was downloaded on 5th May 2025.

# Data

The following table shows how were the economic preferences from the GPS survey (@falk_global_2018) measured.

+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Preference               | Measurement Approach                  | Description                                                                                                 | Scale (min–max) |
+:=========================+:======================================+:============================================================================================================+:================+
| Time Preference/Patience | Combined quantitative and qualitative | • Quantitative: Five binary choices between immediate vs. delayed financial rewards (today or in 12 months) | -1.3 – 2.8      |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Qualitative: Self-assessment on willingness to wait (11-point Likert scale)                               |                 |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Risk Preference          | Combined quantitative and qualitative | • Quantitative: Five binary choices between fixed lottery and varying sure payments                         | -1.9 – 2.5      |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Qualitative: Self-assessment (11-point Likert scale)                                                      |                 |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Positive Reciprocity     | Combined quantitative and qualitative | • Quantitative: Scenario about giving a gift to a helpful stranger (choice of presents worth 5-30 euros)    | -3.8 – 1.3      |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Qualitative: Self-assessment on willingness to return favors (11-point Likert scale)                      |                 |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Negative Reciprocity     | Three qualitative self-assessments    | • Willingness to take revenge at personal cost                                                              | -1.6 – 2.3      |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Willingness to punish unfair behavior toward self                                                         |                 |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Willingness to punish unfair behavior toward others (prosocial punishment)                                |                 |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Altruism                 | Combined quantitative and qualitative | • Quantitative: Hypothetical donation scenario (how much of 1,000 euros would be donated)                   | -2.6 – 1.7      |
|                          |                                       |                                                                                                             |                 |
|                          |                                       | • Qualitative: Self-assessment on willingness to give without expecting returns (11-point Likert scale)     |                 |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+
| Trust                    | Single qualitative item               | • Self-assessment on whether others have the best intentions (11-point Likert scale)                        | -2 – 1.7        |
+--------------------------+---------------------------------------+-------------------------------------------------------------------------------------------------------------+-----------------+

+--------------------------------------+------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------+
| Value                                | Measurement approach                                                   | Description                                                                                                                                                                                | Scale (min – max)                                                    |
+======================================+========================================================================+============================================================================================================================================================================================+======================================================================+
| Liberal democracy index (v2x_libdem) | Aggregation of **55 unique indicators** using Bayesian factor analysis | The indicators come from the Liberal Democracy index and Liberal component index. [Here](https://www.v-dem.net/documents/57/structureofaggregation.pdf) you can find the exact indicators. | **0**(least liberal democratic) **–** **1**(most liberal democratic) |
+--------------------------------------+------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------+

Since we have information about age of each individual during the time of interview in the GPS survey, we were able to calculate their birth years. Then we could determine whether they experienced a regime change during their formative years. For this, we had to link the V-Dem dataset with the GPS survey data. Our goal was to separate the treated and control group of individuals based on the change of liberal democracy index from the V-Dem dataset. **The treated group in our analysis consists of individuals, who experienced a regime change before turning 21 years old**. We are still considering a range of 18-21 years, since this range aligns with legal adulthood in many countries. We are planning to test multiple thresholds, to see if our results will be robust across different specifications. **The regime change is determined as a year over year change in the Liberal democracy index**. Here we also had to decide on a **threshold**, which we think is rather arbitrary. That is why we are considering a different approach, to capture linear changes of the index, not just sudden changes over years.

Assigning the formative years threshold to 21 years results to the following number of observations in both groups

```{r}
#| echo: false
#| label: tbl-c
#| tbl-pos: "H"
table(final_data$formative_regime_change)
```

## Sample period

Our sample period is defined by the birth years of the indviduals, which we calculated based on the age information in the GPS dataset. Each study unit (=individual) appears once. We have data for 80337 individuals.

## Variables

```{r}
#| echo: false
#| label: fig-a
#| warning: false
#| results: 'asis'
#| fig-cap: "Mean Preference Profiles by Regime Change Exposure"
#| fig-cap-location: top
#| fig-pos: "H"
long_data <- final_data_gdp %>%
  pivot_longer(
    cols = c(trust, patience, risktaking, posrecip, negrecip, altruism),
    names_to = "preference_type",
    values_to = "value"
  ) %>%
  mutate(preference_type = str_to_title(preference_type))

# Change the formative_regime_change factor levels and labels
long_data <- long_data %>%
  mutate(formative_regime_change = case_when(
    formative_regime_change == 0 ~ "Control",
    formative_regime_change == 1 ~ "Treated",
    TRUE ~ as.character(formative_regime_change)
  ))

# Calculating group means and confidence intervals
group_means <- long_data %>%
  group_by(formative_regime_change, preference_type) %>%
  summarise(
    mean_value = mean(value, na.rm = TRUE),
    se = sd(value, na.rm = TRUE) / sqrt(n()),
    ci_lower = mean_value - 1.96 * se,
    ci_upper = mean_value + 1.96 * se,
    .groups = "drop"
  )

# Order factors to make Treated come FIRST so it gets the first color (red in Set1)
group_means$formative_regime_change <- factor(
  group_means$formative_regime_change,
  levels = c("Treated", "Control")
)

# Ordering from smallest to highest differences between groups
differences <- group_means %>%
  select(preference_type, formative_regime_change, mean_value) %>%
  pivot_wider(names_from = formative_regime_change, values_from = mean_value) %>%
  mutate(difference = abs(Treated - Control)) %>%
  arrange(difference) %>%
  select(preference_type, difference)

# Create ordered factor for preference_type based on differences
group_means$preference_type <- factor(group_means$preference_type, 
                                      levels = differences$preference_type)

grouped_bar_plot <- ggplot(group_means, aes(x = preference_type, y = mean_value, fill = formative_regime_change)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = round(mean_value, 3)), 
            position = position_dodge(width = 0.8), 
            vjust = ifelse(group_means$mean_value >= 0, -0.3, 1.2),
            size = 3.5,
            fontface = "bold") +
  scale_fill_manual(values = c("Treated" = "#D62728", "Control" = "#1F77B4"),
                    name = "Group") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) +  # Add space for labels
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12),
    legend.position = "top"
  ) +
  labs(
    caption = "Mean values displayed above/below bars",
    x = element_blank(),
    y = "Mean Value"
  ) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray50", size = 0.5)

# Print the plot
print(grouped_bar_plot)
```


In the @fig-a you can see simple mean comparison graph between Treated and Control group for all 6 economic preferences.For completeness, we include **summary statistics** table for all 6 economic preferences in @tbl-preferences. @tbl-controls depicts the summary statistics for our control variables.

```{r}
#| include: false
# Function to perform t-tests and format results
create_ttest_table <- function(data, vars) {
  
  # Initialize results list
  results <- list()
  
  # Ensure formative_regime_change is numeric
  data$formative_regime_change <- as.numeric(data$formative_regime_change)
  
  # Control vs Treatment indicators
  control_group <- data$formative_regime_change == 0
  treatment_group <- data$formative_regime_change == 1
  
  # Check that we have both groups
  if(sum(control_group) == 0) stop("No control group (formative_regime_change = 0) found")
  if(sum(treatment_group) == 0) stop("No treatment group (formative_regime_change = 1) found")
  
  # For each variable, perform t-test and extract statistics
  for(var in vars) {
    # Extract values for control and treatment
    control_vals <- data[[var]][control_group]
    treat_vals <- data[[var]][treatment_group]
    
    # Remove NA values
    control_vals <- control_vals[!is.na(control_vals)]
    treat_vals <- treat_vals[!is.na(treat_vals)]
    
    # Calculate means and SDs
    control_mean <- mean(control_vals)
    control_sd <- sd(control_vals)
    treat_mean <- mean(treat_vals)
    treat_sd <- sd(treat_vals)
    
    # Perform t-test
    t_test <- t.test(treat_vals, control_vals)
    diff <- treat_mean - control_mean
    p_value <- t_test$p.value
    
    # Add significance stars
    stars <- ifelse(p_value < 0.001, "***",
                   ifelse(p_value < 0.01, "**",
                         ifelse(p_value < 0.05, "*",
                               ifelse(p_value < 0.1, "+", ""))))
    
    # Format the results
    control_text <- sprintf("%.3f\n(%.3f)", control_mean, control_sd)
    treat_text <- sprintf("%.3f\n(%.3f)", treat_mean, treat_sd)
    diff_text <- sprintf("%.3f%s\n(%.3f)", diff, stars, t_test$stderr)
    
    # Store results
    results[[var]] <- c(
      Variable = var,
      Control = control_text,
      Treatment = treat_text,
      Difference = diff_text
    )
  }
  
  # Convert to data frame
  table_df <- do.call(rbind, results)
  row.names(table_df) <- NULL
  
  # Create the table using kableExtra for PDF output
  require(kableExtra)
  
  # Clean variable names for display
  display_names <- c(
    trust = "Trust",
    patience = "Patience",
    risktaking = "Risk Taking",
    posrecip = "Positive Reciprocity",
    negrecip = "Negative Reciprocity",
    altruism = "Altruism",
    subj_math_skills = "Subjective Math Skills"
  )
  
  # Replace variable names with display names
  table_df[,1] <- ifelse(table_df[,1] %in% names(display_names), 
                        display_names[table_df[,1]], 
                        table_df[,1])
  
  # Create styled table (without caption - handle in document)
  kbl(table_df, 
      booktabs = TRUE,
      col.names = c("", "Control Group", "Treatment Group", "Difference"),
      align = c("l", "c", "c", "c"),
      escape = FALSE) %>%
    kable_styling() %>%
    add_header_above(c(" " = 1, "Mean (SD)" = 3)) %>%
    column_spec(1, width = "2.5cm") %>%
    column_spec(2:4, width = "2cm") %>%
    footnote(general = "Standard deviations in parentheses. Standard errors for differences in parentheses.",
             symbol = c("*** p<0.001, ** p<0.01, * p<0.05, + p<0.1"),
             threeparttable = TRUE,
             general_title = "Note:",
             escape = FALSE)
}
```

```{r}
#| echo: false
#| label: tbl-preferences
#| warning: false
#| results: 'asis'
#| tbl-cap: "Economic Preferences Comparison by Group"
#| tbl-pos: "H"
# Create the table
preferences_vars <- c("trust", "patience", "risktaking", "posrecip", "negrecip", "altruism")
preferences_table <- create_ttest_table(final_data_gdp, preferences_vars)

# Render the table
preferences_table
```

```{r}
#| echo: false
#| label: tbl-controls
#| warning: false
#| results: 'asis'
#| tbl-cap: "Control Variables Comparison by Group"
#| tbl-pos: "H"
# Create the table
controls_vars <- c("age", "gdppc", "subj_math_skills")
controls_table <- create_ttest_table(final_data_gdp, controls_vars)

# Render the table
controls_table
```

The @fig-b below depict the average values grouped by country in *2012* and *2013*.

```{r mean comparison maps}
#| echo: false
#| label: fig-b
#| warning: false
#| results: 'asis'
#| fig-cap: "Average Economic Preference Values by Country"
#| fig-cap-location: top
#| fig-pos: "H"
country_trust <- final_data_gdp %>%
  group_by(country, isocode) %>%
  summarise(mean_trust = mean(trust, na.rm = TRUE))

country_patience <- final_data_gdp %>%
  group_by(country, isocode) %>%
  summarise(mean_patience = mean(patience, na.rm = TRUE))

# Getting world map data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Creating two separate datasets
world_trust <- left_join(world, country_trust, by = c("name" = "country"))
world_patience <- left_join(world, country_patience, by = c("name" = "country"))

# Creating the plots separately and combining with grid.arrange using longer approach
# Trust map
p1 <- ggplot(data = world_trust) +
  geom_sf(aes(fill = mean_trust), color = "white") +
  scale_fill_viridis_c(option = "C", na.value = "grey90") +
  labs(fill = "Mean Trust") +
  theme_minimal()

# Patience map
p2 <- ggplot(data = world_patience) +
  geom_sf(aes(fill = mean_patience), color = "white") +
  scale_fill_viridis_c(option = "B", na.value = "grey90") +
  labs(fill = "Mean Patience") +
  theme_minimal()

# Combining
combined_plot <- grid.arrange(p1, p2, ncol = 1)

```

# **Descriptive statistics**

The following figures present a detailed **visual overview of the descriptive statistics**, including distribution histograms, group-level comparisons, and difference-in-differences style visualizations highlighting trends across cohorts.

```{r histograms}
#| echo: false
#| warning: false
#| fig-pos: "H"
#| label: fig-c
#| results: 'asis'
#| fig-cap: "Distribution of Key Economic Preferences"
#| fig-cap-location: top
# Function to create histograms with density overlays
create_histogram <- function(data, var_name, title) {
  ggplot(data, aes(x = !!sym(var_name), fill = formative_regime_change, color = formative_regime_change)) +
    geom_histogram(aes(y = after_stat(density)), alpha = 0.5, position = "identity", bins = 30) +
    geom_density(alpha = 0.2) +
    labs(
      title = title,
      x = str_to_title(var_name),
      y = "Density"
    ) +
    scale_fill_brewer(palette = "Set1", name = "Formative Years") +
    scale_color_brewer(palette = "Set1", name = "Formative Years") +
    theme_minimal()
}

# Create histograms for key variables
trust_hist <- create_histogram(final_data_gdp, "trust", "Distribution of Trust")
patience_hist <- create_histogram(final_data_gdp, "patience", "Distribution of Patience")
risk_hist <- create_histogram(final_data_gdp, "risktaking", "Distribution of Risk Taking")

# Combine histograms with a shared legend at the bottom
histograms_combined <- trust_hist + patience_hist + risk_hist +
  plot_layout(ncol = 3, guides = "collect") +  # This collects all guides into one legend
  plot_annotation(
    subtitle = "By regime change exposure during formative years (<21 years)",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  ) &
  theme(legend.position = "bottom")  # This places the collected legend at the bottom

print(histograms_combined)

```

The following figures present additional visualizations of our data. In the following two graphs we are aiming to evaluate the **parallel trends assumption**.

The patience graph shows largely parallel trends for middle-aged groups (30-65), supporting the DiD assumption for these cohorts. A notable divergence appears in older ages (65+), where the no-regime-change group shows sharp decline while the regime-change group remains stable, suggesting potential long-term protective effects of early regime exposure on patience.

The trust graph reveals consistently higher trust levels among those without regime change experience across most age groups.The significant trust gap in youngest cohorts (15-25) provides some evidence supporting the hypothesis that experiencing regime changes during formative years negatively impacts trust development. Interestingly, this gap narrows and even reverses in the oldest cohorts (65+), suggesting possible delayed resilience effects.

```{r}
#| echo: false
#| warning: false
#| fig-pos: "H"
#Creating age groups for visualization
final_data_gdp <- final_data_gdp %>%
  mutate(
    age_group = cut(age, breaks = seq(15, 75, by = 5), include.lowest = TRUE)
  )

trust_by_age <- final_data_gdp %>%
  filter(!is.na(trust), !is.na(formative_regime_change), !is.na(age_group)) %>%
  group_by(age_group, formative_regime_change) %>%
  summarize(
    mean_trust = mean(trust, na.rm = TRUE),
    se_trust = sd(trust, na.rm = TRUE) / sqrt(n()),
    n = n(),
    .groups = 'drop'
  ) %>%
  filter(n >= 10)  # Only including groups with sufficient observations

patience_by_age <- final_data_gdp %>%
  filter(!is.na(patience), !is.na(formative_regime_change), !is.na(age_group)) %>%
  group_by(age_group, formative_regime_change) %>%
  summarize(
    mean_patience = mean(patience),
    se_patience = sd(patience) / sqrt(n()),
    n = n(),
    .groups = 'drop'
  ) %>%
  filter(n >= 10)

#Plot
ggplot(trust_by_age, aes(x = age_group, y = mean_trust, 
                         group = formative_regime_change, 
                         color = formative_regime_change)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_trust - 1.96*se_trust, 
                    ymax = mean_trust + 1.96*se_trust), 
                width = 0.2) +
  labs(title = "Trust by Age Cohort and Regime Change Experience",
       x = "Age Group",
       y = "Mean Trust",
       color = "Regime Change Experience") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 8))

#Plot
ggplot(patience_by_age, aes(x = age_group, y = mean_patience,
                      group = formative_regime_change,
                      color = formative_regime_change)) +
  geom_line(linewidth = 1, na.rm = TRUE) +
  geom_point(size = 3, na.rm = TRUE) +
  geom_errorbar(aes(ymin = mean_patience - 1.96*se_patience,
                    ymax = mean_patience + 1.96*se_patience),
                width = 0.2, na.rm = TRUE) +
  labs(title = "Patience by Age Cohort and Regime Change Experience",
       x = "Age group",
       y = "Mean Patience",
       color = "Regime Change Experience") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 8))

```

```{r}
#| echo: false
democracy_2012 <- vdem_sub %>%
  filter(year == 2012) %>%
  select(country_name,country_text_id, v2x_libdem)
# Merge democracy index into the individual-level dataset
mixed_plot_data <- left_join(final_data_gdp, democracy_2012, by =c ("country"= "country_name"))

ggplot(mixed_plot_data, aes(x = subj_math_skills, y = trust, color = formative_regime_change)) + 
  geom_smooth(method = "loess", se = FALSE, size = 1.2) +
  theme_minimal() +
  labs(title = "Trust Score vs. Subjective Math Skills by Regime Change Exposure",
       x = "Subjective Math Skills",
       y = "Trust",
       color = "Formative Regime Change")
```

### References

::: {#refs}
:::
